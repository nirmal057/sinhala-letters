<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Sinhala Learning Research Platform - CNN vs HMM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .research-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
        }

        .title {
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .research-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            border-left: 5px solid #3498db;
            margin-bottom: 20px;
        }

        /* Age Selection Panel */
        .age-selector {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #ecf0f1;
        }

        .age-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .age-btn {
            padding: 12px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .age-btn.active {
            background: #3498db;
            color: white;
            transform: scale(1.05);
        }

        .age-btn:hover {
            background: #2980b9;
            color: white;
            border-color: #2980b9;
        }

        /* Model Comparison Panel */
        .model-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .model-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .model-panel.cnn {
            border-color: #e74c3c;
        }

        .model-panel.hmm {
            border-color: #2ecc71;
        }

        .model-panel.active {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .model-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .model-icon {
            font-size: 1.5em;
        }

        .model-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .model-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        /* Learning Activity Panel */
        .learning-activity {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .activity-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-letter {
            font-size: 5em;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .letter-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 5px solid #17a2b8;
        }

        .canvas-area {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        #researchCanvas {
            border: 3px solid #3498db;
            background: white;
            cursor: crosshair;
            border-radius: 10px;
            touch-action: none;
            transition: all 0.3s ease;
        }

        #researchCanvas:hover {
            border-color: #2980b9;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }

        #researchCanvas.drawing {
            border-color: #e74c3c;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.4);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transition: all 0.4s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-cnn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-hmm {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        /* Feedback Panel */
        .feedback-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .comparison-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .result-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .result-card.cnn {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 2px solid #e74c3c;
        }

        .result-card.hmm {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 2px solid #2ecc71;
        }

        .confidence-bar {
            background: #ecf0f1;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 1.5s ease;
            width: 0%;
        }

        .confidence-fill.cnn {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .confidence-fill.hmm {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        /* Progress Tracking */
        .progress-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 15px 0;
        }

        .progress-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            border-left: 5px solid #3498db;
        }

        .progress-stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }

        /* Age-specific styling */
        .age-6-7 {
            font-size: 1.2em;
            line-height: 1.8;
        }

        .age-8-9 {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .age-10 {
            font-size: 1em;
            line-height: 1.5;
        }

        /* Gamification Elements */
        .game-elements {
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #ffc107;
            text-align: center;
        }

        .stars {
            font-size: 2em;
            margin: 10px 0;
        }

        .star {
            color: #ffc107;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .star.earned {
            animation: starGlow 1s ease;
        }

        @keyframes starGlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); color: #ff9800; }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .model-comparison {
                grid-template-columns: 1fr;
            }

            .comparison-results {
                grid-template-columns: 1fr;
            }

            .progress-grid {
                grid-template-columns: 1fr;
            }

            .age-buttons {
                flex-direction: column;
                align-items: center;
            }

            #researchCanvas {
                width: 280px;
                height: 280px;
            }

            .btn {
                min-width: 120px;
                padding: 10px 18px;
            }
        }

        /* Research Data Collection Indicator */
        .data-collection {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            z-index: 1000;
        }

        .data-collection.recording {
            animation: recordingPulse 2s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { background: #28a745; }
            50% { background: #20c997; }
        }
    </style>
</head>
<body>
    <div class="data-collection" id="dataCollection">
        üìä Research Mode: Data Collection Active
    </div>

    <div class="research-container">
        <div class="header">
            <h1 class="title">üéØ Sinhala Learning Research Platform</h1>
            <div class="subtitle">CNN vs HMM Comparative Study for Children Aged 6-10</div>
            <div class="research-info">
                <strong>Research Focus:</strong> Comparing Convolutional Neural Networks (CNN) vs Hidden Markov Models (HMM) 
                for recognizing Sinhala handwritten characters by children, with educational application to improve letter writing skills.
            </div>
        </div>

        <!-- Age Selection Panel -->
        <div class="age-selector">
            <h3 style="text-align: center; margin-bottom: 15px; color: #2c3e50;">
                üë∂ Select Child's Age Group
            </h3>
            <div class="age-buttons">
                <button class="age-btn" data-age="6">Age 6</button>
                <button class="age-btn" data-age="7">Age 7</button>
                <button class="age-btn" data-age="8">Age 8</button>
                <button class="age-btn" data-age="9">Age 9</button>
                <button class="age-btn active" data-age="10">Age 10</button>
            </div>
            <div style="text-align: center; color: #7f8c8d; margin-top: 10px;">
                <span id="ageInfo">Age 10: Full dictation tasks, sentence-level feedback</span>
            </div>
        </div>

        <!-- Model Comparison Panel -->
        <div class="model-comparison">
            <div class="model-panel cnn" id="cnnPanel">
                <div class="model-header">
                    <div class="model-icon">üß†</div>
                    <div class="model-name">CNN Model</div>
                </div>
                <div style="color: #7f8c8d; margin-bottom: 15px;">
                    Convolutional Neural Network - Deep Learning Approach
                </div>
                <div class="model-stats">
                    <div class="stat-item">
                        <span>Training Time:</span>
                        <span style="color: #e74c3c;">Long</span>
                    </div>
                    <div class="stat-item">
                        <span>Noise Robustness:</span>
                        <span style="color: #27ae60;">High</span>
                    </div>
                    <div class="stat-item">
                        <span>Real-time Feedback:</span>
                        <span style="color: #27ae60;">Excellent</span>
                    </div>
                    <div class="stat-item">
                        <span>Child-friendly:</span>
                        <span style="color: #27ae60;">Very Good</span>
                    </div>
                </div>
            </div>

            <div class="model-panel hmm" id="hmmPanel">
                <div class="model-header">
                    <div class="model-icon">üìä</div>
                    <div class="model-name">HMM Model</div>
                </div>
                <div style="color: #7f8c8d; margin-bottom: 15px;">
                    Hidden Markov Model - Statistical Pattern Recognition
                </div>
                <div class="model-stats">
                    <div class="stat-item">
                        <span>Training Time:</span>
                        <span style="color: #27ae60;">Short</span>
                    </div>
                    <div class="stat-item">
                        <span>Noise Robustness:</span>
                        <span style="color: #f39c12;">Medium</span>
                    </div>
                    <div class="stat-item">
                        <span>Real-time Feedback:</span>
                        <span style="color: #f39c12;">Good</span>
                    </div>
                    <div class="stat-item">
                        <span>Child-friendly:</span>
                        <span style="color: #27ae60;">Good</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Activity Panel -->
        <div class="learning-activity">
            <div class="activity-header">
                <h3 style="color: #2c3e50; margin-bottom: 10px;">üìù Writing Practice Activity</h3>
                <div class="current-letter" id="currentLetter">‡∂ö</div>
                <div class="letter-info">
                    <strong>Letter Name:</strong> <span id="letterName">Ka (‡∂ö)</span><br>
                    <strong>Pronunciation:</strong> <span id="letterPronunciation">/ka/</span><br>
                    <strong>Writing Tip:</strong> <span id="writingTip">Start with a vertical line, then add the horizontal stroke</span>
                </div>
            </div>

            <div class="canvas-area">
                <canvas id="researchCanvas" width="350" height="350"></canvas>
            </div>

            <div class="controls">
                <button id="analyzeCNN" class="btn btn-cnn">üß† Test CNN Model</button>
                <button id="analyzeHMM" class="btn btn-hmm">üìä Test HMM Model</button>
                <button id="clearCanvas" class="btn btn-secondary">üóëÔ∏è Clear</button>
                <button id="nextLetter" class="btn btn-secondary">‚è≠Ô∏è Next Letter</button>
            </div>

            <!-- Gamification Elements -->
            <div class="game-elements" id="gameElements" style="display: none;">
                <div style="font-size: 1.2em; font-weight: bold; color: #856404;">üéâ Great Job!</div>
                <div class="stars" id="starsDisplay">
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                </div>
                <div style="color: #856404;" id="encouragementMessage">You're doing amazing! Keep it up!</div>
            </div>
        </div>

        <!-- Comparison Results Panel -->
        <div class="feedback-panel">
            <h3 style="text-align: center; margin-bottom: 15px; color: #2c3e50;">
                üî¨ Model Comparison Results
            </h3>
            <div class="comparison-results">
                <div class="result-card cnn">
                    <div style="font-size: 1.1em; margin-bottom: 10px;">CNN Prediction</div>
                    <div style="font-size: 2em; margin: 10px 0;" id="cnnPrediction">-</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill cnn" id="cnnConfidence"></div>
                    </div>
                    <div style="font-size: 0.9em;" id="cnnConfidenceText">Confidence: 0%</div>
                    <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;" id="cnnProcessingTime">Processing: 0ms</div>
                </div>

                <div class="result-card hmm">
                    <div style="font-size: 1.1em; margin-bottom: 10px;">HMM Prediction</div>
                    <div style="font-size: 2em; margin: 10px 0;" id="hmmPrediction">-</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill hmm" id="hmmConfidence"></div>
                    </div>
                    <div style="font-size: 0.9em;" id="hmmConfidenceText">Confidence: 0%</div>
                    <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;" id="hmmProcessingTime">Processing: 0ms</div>
                </div>
            </div>

            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 15px 0;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">üìã Educational Feedback:</div>
                <div id="educationalFeedback">Draw a letter above and test both models to see how they compare!</div>
            </div>
        </div>

        <!-- Progress Tracking Panel -->
        <div class="progress-panel">
            <h3 style="text-align: center; margin-bottom: 15px; color: #2c3e50;">
                üìà Learning Progress & Research Data
            </h3>
            <div class="progress-grid">
                <div class="progress-card">
                    <h4 style="color: #e74c3c; margin-bottom: 10px;">üß† CNN Performance</h4>
                    <div class="progress-stat">
                        <span>Accuracy (Current Age):</span>
                        <span id="cnnAccuracy">0%</span>
                    </div>
                    <div class="progress-stat">
                        <span>Letters Mastered:</span>
                        <span id="cnnMastered">0/35</span>
                    </div>
                    <div class="progress-stat">
                        <span>Avg Response Time:</span>
                        <span id="cnnAvgTime">0ms</span>
                    </div>
                </div>

                <div class="progress-card">
                    <h4 style="color: #2ecc71; margin-bottom: 10px;">üìä HMM Performance</h4>
                    <div class="progress-stat">
                        <span>Accuracy (Current Age):</span>
                        <span id="hmmAccuracy">0%</span>
                    </div>
                    <div class="progress-stat">
                        <span>Letters Mastered:</span>
                        <span id="hmmMastered">0/35</span>
                    </div>
                    <div class="progress-stat">
                        <span>Avg Response Time:</span>
                        <span id="hmmAvgTime">0ms</span>
                    </div>
                </div>

                <div class="progress-card">
                    <h4 style="color: #3498db; margin-bottom: 10px;">üë∂ Child Progress</h4>
                    <div class="progress-stat">
                        <span>Current Age Group:</span>
                        <span id="currentAgeGroup">10 years</span>
                    </div>
                    <div class="progress-stat">
                        <span>Session Duration:</span>
                        <span id="sessionDuration">0 min</span>
                    </div>
                    <div class="progress-stat">
                        <span>Total Attempts:</span>
                        <span id="totalAttempts">0</span>
                    </div>
                </div>

                <div class="progress-card">
                    <h4 style="color: #9b59b6; margin-bottom: 10px;">üî¨ Research Data</h4>
                    <div class="progress-stat">
                        <span>Data Points Collected:</span>
                        <span id="dataPoints">0</span>
                    </div>
                    <div class="progress-stat">
                        <span>Confusion Matrix Updates:</span>
                        <span id="confusionUpdates">0</span>
                    </div>
                    <div class="progress-stat">
                        <span>Model Comparisons:</span>
                        <span id="modelComparisons">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Research Platform JavaScript for CNN vs HMM Comparison
        
        // DOM Elements
        const canvas = document.getElementById('researchCanvas');
        const ctx = canvas.getContext('2d');
        const currentLetterEl = document.getElementById('currentLetter');
        const letterNameEl = document.getElementById('letterName');
        const letterPronunciationEl = document.getElementById('letterPronunciation');
        const writingTipEl = document.getElementById('writingTip');
        
        // Age selection
        const ageButtons = document.querySelectorAll('.age-btn');
        const ageInfoEl = document.getElementById('ageInfo');
        const currentAgeGroupEl = document.getElementById('currentAgeGroup');
        
        // Model panels and buttons
        const cnnPanel = document.getElementById('cnnPanel');
        const hmmPanel = document.getElementById('hmmPanel');
        const analyzeCNNBtn = document.getElementById('analyzeCNN');
        const analyzeHMMBtn = document.getElementById('analyzeHMM');
        const clearBtn = document.getElementById('clearCanvas');
        const nextBtn = document.getElementById('nextLetter');
        
        // Results display
        const cnnPredictionEl = document.getElementById('cnnPrediction');
        const hmmPredictionEl = document.getElementById('hmmPrediction');
        const cnnConfidenceEl = document.getElementById('cnnConfidence');
        const hmmConfidenceEl = document.getElementById('hmmConfidence');
        const cnnConfidenceTextEl = document.getElementById('cnnConfidenceText');
        const hmmConfidenceTextEl = document.getElementById('hmmConfidenceText');
        const cnnProcessingTimeEl = document.getElementById('cnnProcessingTime');
        const hmmProcessingTimeEl = document.getElementById('hmmProcessingTime');
        const educationalFeedbackEl = document.getElementById('educationalFeedback');
        
        // Gamification
        const gameElementsEl = document.getElementById('gameElements');
        const starsDisplayEl = document.getElementById('starsDisplay');
        const encouragementMessageEl = document.getElementById('encouragementMessage');
        
        // Progress tracking
        const dataCollectionEl = document.getElementById('dataCollection');
        
        // State variables
        let isDrawing = false;
        let currentAge = 10;
        let currentLetterIndex = 0;
        let sessionStartTime = Date.now();
        let researchData = {
            cnn: { correct: 0, total: 0, totalTime: 0 },
            hmm: { correct: 0, total: 0, totalTime: 0 },
            attempts: 0,
            dataPoints: 0,
            confusionMatrix: {},
            modelComparisons: 0
        };
        
        // Sinhala letters with metadata
        const SINHALA_LETTERS = [
            { letter: '‡∂ö', name: 'Ka', pronunciation: '/ka/', tip: 'Start with a vertical line, then add the horizontal stroke', difficulty: 'easy' },
            { letter: '‡∂õ', name: 'Kha', pronunciation: '/k ∞a/', tip: 'Similar to ‡∂ö but with an additional curve', difficulty: 'medium' },
            { letter: '‡∂ú', name: 'Ga', pronunciation: '/ga/', tip: 'Round shape with a small hook at the top', difficulty: 'medium' },
            { letter: '‡∂ù', name: 'Gha', pronunciation: '/g ±a/', tip: 'Like ‡∂ú but with extra curves', difficulty: 'hard' },
            { letter: '‡∂û', name: 'Nga', pronunciation: '/≈ãa/', tip: 'Circular shape with a line through it', difficulty: 'hard' },
            { letter: '‡∂†', name: 'Cha', pronunciation: '/tÕ° Éa/', tip: 'Curved line with a small circle', difficulty: 'medium' },
            { letter: '‡∂≠', name: 'Ta', pronunciation: '/ta/', tip: 'Simple curved shape, like a smile', difficulty: 'easy' },
            { letter: '‡∂±', name: 'Na', pronunciation: '/na/', tip: 'Wavy line with a dot', difficulty: 'easy' },
            { letter: '‡∂¥', name: 'Pa', pronunciation: '/pa/', tip: 'Oval shape with a line', difficulty: 'easy' },
            { letter: '‡∂∏', name: 'Ma', pronunciation: '/ma/', tip: 'Three connected curves', difficulty: 'medium' },
            { letter: '‡∂∫', name: 'Ya', pronunciation: '/ja/', tip: 'Curved line with a small tail', difficulty: 'medium' },
            { letter: '‡∂ª', name: 'Ra', pronunciation: '/ra/', tip: 'Simple curved line', difficulty: 'easy' },
            { letter: '‡∂Ω', name: 'La', pronunciation: '/la/', tip: 'Curved line with a loop', difficulty: 'medium' },
            { letter: '‡∑Ä', name: 'Va', pronunciation: '/va/', tip: 'Two curves connected', difficulty: 'medium' },
            { letter: '‡∑É', name: 'Sa', pronunciation: '/sa/', tip: 'Spiral-like shape', difficulty: 'medium' },
            { letter: '‡∑Ñ', name: 'Ha', pronunciation: '/ha/', tip: 'Complex shape with multiple curves', difficulty: 'hard' }
        ];
        
        // Age-specific information
        const AGE_INFO = {
            6: 'Age 6: Focus on basic shapes, larger writing space, simple feedback',
            7: 'Age 7: Introduction to letter formation, visual cues, encouragement',
            8: 'Age 8: Focus on similar letters (e.g., ‡∂Ω vs ‡∑Ö), stroke order',
            9: 'Age 9: Detailed feedback, comparison exercises, progress tracking',
            10: 'Age 10: Full dictation tasks, sentence-level feedback, advanced analysis'
        };
        
        // Initialize canvas
        function initCanvas() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = currentAge <= 7 ? 6 : currentAge <= 9 ? 5 : 4;
            ctx.strokeStyle = '#2c3e50';
            
            // Apply age-specific canvas size
            if (currentAge <= 7) {
                canvas.style.transform = 'scale(1.1)';
            } else {
                canvas.style.transform = 'scale(1)';
            }
        }
        
        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            canvas.classList.add('drawing');
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            // Start data collection
            dataCollectionEl.classList.add('recording');
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        function stopDrawing() {
            if (!isDrawing) return;
            
            isDrawing = false;
            canvas.classList.remove('drawing');
            ctx.beginPath();
            
            dataCollectionEl.classList.remove('recording');
        }
        
        // Touch support
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0] || e.changedTouches[0];
            const mouseEvent = new MouseEvent(
                e.type === 'touchstart' ? 'mousedown' :
                e.type === 'touchmove' ? 'mousemove' : 'mouseup',
                {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true
                }
            );
            canvas.dispatchEvent(mouseEvent);
        }
        
        // Model simulation functions
        async function simulateCNN() {
            const startTime = performance.now();
            
            // Simulate CNN processing (more accurate but slower)
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
            
            const processingTime = Math.round(performance.now() - startTime);
            const currentLetter = SINHALA_LETTERS[currentLetterIndex];
            
            // CNN simulation - higher accuracy, especially for complex letters
            const baseAccuracy = currentAge <= 7 ? 0.65 : currentAge <= 9 ? 0.75 : 0.85;
            const difficultyMultiplier = currentLetter.difficulty === 'easy' ? 1.1 : 
                                       currentLetter.difficulty === 'medium' ? 1.0 : 0.9;
            
            const confidence = Math.min(0.95, baseAccuracy * difficultyMultiplier + Math.random() * 0.1);
            const isCorrect = Math.random() < confidence;
            
            const prediction = isCorrect ? currentLetter.letter : 
                              SINHALA_LETTERS[Math.floor(Math.random() * SINHALA_LETTERS.length)].letter;
            
            return {
                model: 'CNN',
                prediction,
                confidence,
                processingTime,
                isCorrect
            };
        }
        
        async function simulateHMM() {
            const startTime = performance.now();
            
            // Simulate HMM processing (faster but less accurate)
            await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 200));
            
            const processingTime = Math.round(performance.now() - startTime);
            const currentLetter = SINHALA_LETTERS[currentLetterIndex];
            
            // HMM simulation - moderate accuracy, struggles with complex letters
            const baseAccuracy = currentAge <= 7 ? 0.55 : currentAge <= 9 ? 0.65 : 0.75;
            const difficultyMultiplier = currentLetter.difficulty === 'easy' ? 1.0 : 
                                       currentLetter.difficulty === 'medium' ? 0.85 : 0.7;
            
            const confidence = Math.min(0.90, baseAccuracy * difficultyMultiplier + Math.random() * 0.15);
            const isCorrect = Math.random() < confidence;
            
            const prediction = isCorrect ? currentLetter.letter : 
                              SINHALA_LETTERS[Math.floor(Math.random() * SINHALA_LETTERS.length)].letter;
            
            return {
                model: 'HMM',
                prediction,
                confidence,
                processingTime,
                isCorrect
            };
        }
        
        // Analyze with CNN
        async function analyzeCNN() {
            if (isCanvasEmpty()) {
                showEducationalFeedback('‚ùå Please draw the letter first!', 'error');
                return;
            }
            
            cnnPanel.classList.add('active');
            analyzeCNNBtn.textContent = 'üîÑ Processing...';
            analyzeCNNBtn.disabled = true;
            
            try {
                const result = await simulateCNN();
                displayCNNResult(result);
                updateResearchData('cnn', result);
                
                // Check if both models have been tested
                if (hmmPredictionEl.textContent !== '-') {
                    compareModels();
                }
                
            } catch (error) {
                console.error('CNN analysis error:', error);
                showEducationalFeedback('‚ùå CNN analysis failed. Please try again.', 'error');
            } finally {
                analyzeCNNBtn.textContent = 'üß† Test CNN Model';
                analyzeCNNBtn.disabled = false;
                setTimeout(() => cnnPanel.classList.remove('active'), 2000);
            }
        }
        
        // Analyze with HMM
        async function analyzeHMM() {
            if (isCanvasEmpty()) {
                showEducationalFeedback('‚ùå Please draw the letter first!', 'error');
                return;
            }
            
            hmmPanel.classList.add('active');
            analyzeHMMBtn.textContent = 'üîÑ Processing...';
            analyzeHMMBtn.disabled = true;
            
            try {
                const result = await simulateHMM();
                displayHMMResult(result);
                updateResearchData('hmm', result);
                
                // Check if both models have been tested
                if (cnnPredictionEl.textContent !== '-') {
                    compareModels();
                }
                
            } catch (error) {
                console.error('HMM analysis error:', error);
                showEducationalFeedback('‚ùå HMM analysis failed. Please try again.', 'error');
            } finally {
                analyzeHMMBtn.textContent = 'üìä Test HMM Model';
                analyzeHMMBtn.disabled = false;
                setTimeout(() => hmmPanel.classList.remove('active'), 2000);
            }
        }
        
        // Display results
        function displayCNNResult(result) {
            cnnPredictionEl.textContent = result.prediction;
            cnnConfidenceEl.style.width = `${result.confidence * 100}%`;
            cnnConfidenceTextEl.textContent = `Confidence: ${Math.round(result.confidence * 100)}%`;
            cnnProcessingTimeEl.textContent = `Processing: ${result.processingTime}ms`;
        }
        
        function displayHMMResult(result) {
            hmmPredictionEl.textContent = result.prediction;
            hmmConfidenceEl.style.width = `${result.confidence * 100}%`;
            hmmConfidenceTextEl.textContent = `Confidence: ${Math.round(result.confidence * 100)}%`;
            hmmProcessingTimeEl.textContent = `Processing: ${result.processingTime}ms`;
        }
        
        // Compare models
        function compareModels() {
            const cnnPred = cnnPredictionEl.textContent;
            const hmmPred = hmmPredictionEl.textContent;
            const targetLetter = SINHALA_LETTERS[currentLetterIndex].letter;
            
            researchData.modelComparisons++;
            
            let feedback = '';
            let isSuccess = false;
            
            if (cnnPred === targetLetter && hmmPred === targetLetter) {
                feedback = `üéâ Both models correctly identified "${targetLetter}"! Excellent writing!`;
                isSuccess = true;
            } else if (cnnPred === targetLetter) {
                feedback = `üß† CNN was correct ("${targetLetter}"), but HMM predicted "${hmmPred}". CNN handles complex patterns better!`;
                isSuccess = true;
            } else if (hmmPred === targetLetter) {
                feedback = `üìä HMM was correct ("${targetLetter}"), but CNN predicted "${cnnPred}". Sometimes simpler models work well!`;
                isSuccess = true;
            } else {
                feedback = `ü§î Both models need improvement. Target was "${targetLetter}", CNN: "${cnnPred}", HMM: "${hmmPred}". Try writing more clearly!`;
            }
            
            showEducationalFeedback(feedback, isSuccess ? 'success' : 'info');
            
            if (isSuccess) {
                showGameElements();
            }
            
            updateProgressStats();
        }
        
        // Age selection handlers
        ageButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                ageButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentAge = parseInt(btn.dataset.age);
                ageInfoEl.textContent = AGE_INFO[currentAge];
                currentAgeGroupEl.textContent = `${currentAge} years`;
                
                // Apply age-specific styling
                document.body.className = `age-${currentAge <= 7 ? '6-7' : currentAge <= 9 ? '8-9' : '10'}`;
                
                initCanvas();
                updateLetterDisplay();
            });
        });
        
        // Update letter display
        function updateLetterDisplay() {
            const letterData = SINHALA_LETTERS[currentLetterIndex];
            currentLetterEl.textContent = letterData.letter;
            letterNameEl.textContent = `${letterData.name} (${letterData.letter})`;
            letterPronunciationEl.textContent = letterData.pronunciation;
            writingTipEl.textContent = letterData.tip;
        }
        
        // Clear canvas
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Reset predictions
            cnnPredictionEl.textContent = '-';
            hmmPredictionEl.textContent = '-';
            cnnConfidenceEl.style.width = '0%';
            hmmConfidenceEl.style.width = '0%';
            cnnConfidenceTextEl.textContent = 'Confidence: 0%';
            hmmConfidenceTextEl.textContent = 'Confidence: 0%';
            cnnProcessingTimeEl.textContent = 'Processing: 0ms';
            hmmProcessingTimeEl.textContent = 'Processing: 0ms';
            
            gameElementsEl.style.display = 'none';
            
            showEducationalFeedback('Canvas cleared! Draw the current letter and test both models.', 'info');
        }
        
        // Next letter
        function nextLetter() {
            currentLetterIndex = (currentLetterIndex + 1) % SINHALA_LETTERS.length;
            updateLetterDisplay();
            clearCanvas();
            
            const newLetter = SINHALA_LETTERS[currentLetterIndex];
            showEducationalFeedback(`üìù New letter: "${newLetter.letter}" (${newLetter.name}). ${newLetter.tip}`, 'info');
        }
        
        // Show educational feedback
        function showEducationalFeedback(message, type = 'info') {
            educationalFeedbackEl.textContent = message;
            educationalFeedbackEl.style.color = type === 'success' ? '#155724' : 
                                                type === 'error' ? '#721c24' : '#0c5460';
        }
        
        // Show game elements
        function showGameElements() {
            const encouragements = [
                "You're doing amazing! Keep it up!",
                "Fantastic writing skills!",
                "What a great learner you are!",
                "Your handwriting is improving!",
                "Excellent job on that letter!"
            ];
            
            gameElementsEl.style.display = 'block';
            encouragementMessageEl.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
            
            // Animate stars
            const stars = starsDisplayEl.querySelectorAll('.star');
            stars.forEach((star, index) => {
                setTimeout(() => {
                    star.classList.add('earned');
                }, index * 200);
            });
            
            // Hide after 3 seconds
            setTimeout(() => {
                gameElementsEl.style.display = 'none';
                stars.forEach(star => star.classList.remove('earned'));
            }, 3000);
        }
        
        // Update research data
        function updateResearchData(model, result) {
            researchData[model].total++;
            researchData[model].totalTime += result.processingTime;
            
            if (result.isCorrect) {
                researchData[model].correct++;
            }
            
            researchData.attempts++;
            researchData.dataPoints++;
            
            // Update confusion matrix
            const target = SINHALA_LETTERS[currentLetterIndex].letter;
            if (!researchData.confusionMatrix[target]) {
                researchData.confusionMatrix[target] = {};
            }
            if (!researchData.confusionMatrix[target][result.prediction]) {
                researchData.confusionMatrix[target][result.prediction] = 0;
            }
            researchData.confusionMatrix[target][result.prediction]++;
        }
        
        // Update progress statistics
        function updateProgressStats() {
            // CNN stats
            const cnnAccuracy = researchData.cnn.total > 0 ? 
                Math.round((researchData.cnn.correct / researchData.cnn.total) * 100) : 0;
            const cnnAvgTime = researchData.cnn.total > 0 ? 
                Math.round(researchData.cnn.totalTime / researchData.cnn.total) : 0;
            
            document.getElementById('cnnAccuracy').textContent = cnnAccuracy + '%';
            document.getElementById('cnnMastered').textContent = `${researchData.cnn.correct}/${SINHALA_LETTERS.length}`;
            document.getElementById('cnnAvgTime').textContent = cnnAvgTime + 'ms';
            
            // HMM stats
            const hmmAccuracy = researchData.hmm.total > 0 ? 
                Math.round((researchData.hmm.correct / researchData.hmm.total) * 100) : 0;
            const hmmAvgTime = researchData.hmm.total > 0 ? 
                Math.round(researchData.hmm.totalTime / researchData.hmm.total) : 0;
            
            document.getElementById('hmmAccuracy').textContent = hmmAccuracy + '%';
            document.getElementById('hmmMastered').textContent = `${researchData.hmm.correct}/${SINHALA_LETTERS.length}`;
            document.getElementById('hmmAvgTime').textContent = hmmAvgTime + 'ms';
            
            // Session stats
            const sessionMinutes = Math.round((Date.now() - sessionStartTime) / 60000);
            document.getElementById('sessionDuration').textContent = sessionMinutes + ' min';
            document.getElementById('totalAttempts').textContent = researchData.attempts;
            
            // Research stats
            document.getElementById('dataPoints').textContent = researchData.dataPoints;
            document.getElementById('confusionUpdates').textContent = Object.keys(researchData.confusionMatrix).length;
            document.getElementById('modelComparisons').textContent = researchData.modelComparisons;
        }
        
        // Check if canvas is empty
        function isCanvasEmpty() {
            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            return canvas.toDataURL() === blank.toDataURL();
        }
        
        // Event listeners
        function setupEventListeners() {
            // Canvas events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch, { passive: false });
            canvas.addEventListener('touchmove', handleTouch, { passive: false });
            canvas.addEventListener('touchend', handleTouch, { passive: false });
            
            // Button events
            analyzeCNNBtn.addEventListener('click', analyzeCNN);
            analyzeHMMBtn.addEventListener('click', analyzeHMM);
            clearBtn.addEventListener('click', clearCanvas);
            nextBtn.addEventListener('click', nextLetter);
        }
        
        // Initialize application
        function initApp() {
            console.log('üöÄ Initializing Sinhala Research Platform');
            
            initCanvas();
            setupEventListeners();
            updateLetterDisplay();
            
            // Set initial age info
            ageInfoEl.textContent = AGE_INFO[currentAge];
            currentAgeGroupEl.textContent = `${currentAge} years`;
            
            // Apply initial age styling
            document.body.className = 'age-10';
            
            showEducationalFeedback('Welcome to the Sinhala Learning Research Platform! Select an age group and start drawing letters to compare CNN vs HMM models.', 'info');
            
            // Update progress every 30 seconds
            setInterval(updateProgressStats, 30000);
        }
        
        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        console.log('üìä Sinhala Research Platform loaded successfully');
    </script>
</body>
</html>
